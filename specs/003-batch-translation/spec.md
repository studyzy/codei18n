# 功能规范: 批量翻译优化 (Batch Translation)

**功能分支**: `003-batch-translation`
**创建时间**: 2025-12-17
**状态**: 草稿
**输入**: 用户描述: "优化翻译效率，将多个注释合并为一个Batch发送给LLM进行翻译，并确保输入输出一一对应"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 批量翻译注释 (优先级: P1)

作为一名开发者，我希望系统能够将多个注释合并为一个请求发送给翻译引擎，以提高翻译速度并减少 API 请求次数。

**优先级原因**: 逐条翻译效率极低，特别是在处理大型项目时，API 延迟和速率限制会严重阻碍使用体验。

**独立测试**: 编写模拟测试，输入 10 条待翻译注释，验证系统是否将其合并为 1-2 个 API 请求（取决于 Batch Size），并正确返回 10 条对应的翻译结果。

**验收场景**:

1. **给定** 100 条待翻译的英文注释, **当** 运行翻译命令时, **那么** 系统应发送不超过 10 个 API 请求（假设 Batch Size=10）。
2. **给定** 一个 Batch 请求成功返回, **那么** 系统应将返回的翻译列表准确映射回原始的 10 个注释 ID，无错位。
3. **给定** LLM 返回的翻译条数与输入不一致（例如丢弃或合并了某些项）, **那么** 系统应检测到错误，并将该 Batch 降级为逐条翻译或标记为失败，避免错误映射。

---

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须支持将待翻译任务分组（Batching）。
- **FR-002**: 必须提供可配置的 `batch_size` 参数（默认 10）。
- **FR-003**: 必须设计一种 Prompt 格式，指示 LLM 以结构化格式（如 JSON Array 或特定分隔符）返回翻译结果，且保持顺序。
- **FR-004**: 系统必须实现“结果对齐验证”逻辑：
    - 如果 `len(inputs) != len(outputs)`，视为 Batch 失败。
    - 失败时支持重试策略（如减小 Batch Size 重试，或回退到逐条翻译）。
- **FR-005**: 翻译引擎接口 (`Translator`) 必须显式支持 `TranslateBatch` 方法。

### 边界情况

- **LLM 输出格式错误**: LLM 可能返回非 JSON 格式，或在 JSON 中包含注释。解析器需要具备一定的鲁棒性或重试机制。
- **单个超长注释**: 如果某条注释本身接近 Token 限制，应将其单独作为一个 Batch 处理。
- **混合语言/特殊字符**: 注释中包含 Markdown、代码片段或特殊字符，可能破坏 JSON 结构。Prompt 需强调转义或使用分隔符。

### 关键实体

- **BatchTranslator**: 负责构建 Batch 请求、调用 LLM、解析响应并处理错误回退。

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 翻译 100 条注释的总耗时减少 50% 以上（相比逐条翻译）。
- **SC-002**: 翻译准确率（映射正确性）保持 100%，无错位现象。

### 质量门槛（CodeI18n 项目要求）

- **QG-001**: 单元测试覆盖率达到 60% 以上
- **QG-002**: 核心模块（comment、mapping、translate）测试覆盖率达到 80% 以上
- **QG-003**: 所有代码通过 `gofmt` 格式化
- **QG-004**: 所有代码通过 `golint` 或 `staticcheck` 检查
- **QG-005**: 所有公共函数和类型有中文 GoDoc 注释
- **QG-006**: 所有文档使用中文编写
